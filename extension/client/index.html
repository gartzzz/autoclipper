<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoClipper</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Debug Panel -->
    <div id="debug-panel" class="debug-panel hidden">
        <div class="debug-header">
            <span>Debug Console</span>
            <button id="debug-close" class="debug-close">√ó</button>
        </div>
        <div id="debug-logs" class="debug-logs"></div>
        <button id="debug-clear" class="debug-clear-btn">Clear</button>
    </div>
    <button id="debug-toggle" class="debug-toggle" title="Toggle Debug Console">D</button>

    <div id="app">
        <!-- Estado 1: Setup -->
        <section id="setup-state" class="state active">
            <header class="panel-header">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <h1>AutoClipper</h1>
                    <span id="plan-badge" class="plan-badge plan-free hidden">Free</span>
                </div>
                <button id="settings-btn" class="icon-btn" title="Configuracion">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                    </svg>
                </button>
            </header>

            <div class="content">
                <div id="model-status" class="model-status hidden">
                    <div class="status-indicator">
                        <span id="model-status-dot" class="status-dot"></span>
                        <span id="model-status-text">Modelo no cargado</span>
                    </div>
                    <button id="model-power-btn" class="power-btn" title="Mantener modelo cargado">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M7.5 1v7h1V1h-1z"/>
                            <path d="M3 8.812a4.999 4.999 0 0 1 2.578-4.375l-.485-.874A6 6 0 1 0 11 3.616l-.501.865A5 5 0 1 1 3 8.812z"/>
                        </svg>
                    </button>
                </div>

                <label class="input-label">Pega la transcripcion aqui:</label>
                <div id="transcript-drop" class="drop-zone" tabindex="0">
                    <textarea id="transcript-input" placeholder="Cmd+V o arrastra un archivo SRT..."></textarea>
                </div>

                <div id="transcript-info" class="info-bar hidden">
                    <span class="check-icon">&#10003;</span>
                    <span id="word-count">0 palabras detectadas</span>
                </div>

                <button id="analyze-btn" class="primary-btn" disabled>
                    Analizar Momentos Virales
                </button>

                <p class="tip">
                    <strong>Tip:</strong> En Premiere, panel Transcripcion ‚Üí Click derecho ‚Üí "Copy Transcript"
                </p>
            </div>
        </section>

        <!-- Estado 2: Review -->
        <section id="review-state" class="state">
            <header class="panel-header">
                <button id="back-to-setup" class="icon-btn" title="Volver">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"/>
                    </svg>
                </button>
                <span id="review-title">Revisar Momentos</span>
                <div class="nav-keys">
                    <span class="key">‚Üê</span>
                    <span class="key">‚Üí</span>
                </div>
            </header>

            <div class="content">
                <div id="clip-counter" class="clip-counter">[Clip 1/8]</div>
                <h2 id="clip-title" class="clip-title">Hook emocional</h2>

                <div id="clip-preview" class="clip-preview">
                    <div class="waveform-placeholder"></div>
                    <button id="play-in-monitor" class="play-btn">Ver en monitor</button>
                </div>

                <div id="clip-transcript" class="clip-transcript">
                    "...y ahi fue cuando todo cambio para siempre..."
                </div>

                <div id="clip-segments" class="clip-segments hidden">
                    <!-- Multi-segment info generated dynamically -->
                </div>

                <div class="clip-meta">
                    <span id="clip-timecode">00:01:34 - 00:02:15</span>
                    <span id="clip-score" class="viral-score">94%</span>
                </div>

                <div class="action-buttons">
                    <button id="reject-btn" class="action-btn reject">
                        <span class="key-hint">‚Üê</span> Rechazar
                    </button>
                    <button id="replay-btn" class="action-btn replay">
                        <span class="key-hint">‚ü≥</span>
                    </button>
                    <button id="skip-btn" class="action-btn skip">
                        <span class="key-hint">S</span> Skip
                    </button>
                    <button id="approve-btn" class="action-btn approve">
                        Aprobar <span class="key-hint">‚Üí</span>
                    </button>
                </div>

                <div class="nav-hint">
                    <span>‚Üë‚Üì Navegar</span>
                    <span>Click en dots para saltar</span>
                </div>

                <div id="progress-dots" class="progress-dots">
                    <!-- Dots generados dinamicamente -->
                </div>

                <div id="upgrade-banner" class="upgrade-banner hidden">
                    <div class="upgrade-banner-icon">PRO</div>
                    <p class="upgrade-banner-text">
                        Has aprobado todos los clips gratuitos.<br>
                        <strong>Upgrade a Pro</strong> para generar secuencias ilimitadas.
                    </p>
                    <button id="upgrade-banner-btn" class="primary-btn upgrade-btn">
                        Desbloquear clips ilimitados
                    </button>
                    <button id="upgrade-banner-login" class="secondary-btn">
                        Ya tengo cuenta
                    </button>
                </div>
            </div>
        </section>

        <!-- Estado 3: Generate -->
        <section id="generate-state" class="state">
            <header class="panel-header">
                <button id="back-to-review" class="icon-btn" title="Volver">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"/>
                    </svg>
                </button>
                <span>Listo para Generar</span>
                <button id="close-generate" class="icon-btn" title="Cerrar">√ó</button>
            </header>

            <div class="content">
                <div id="approved-count" class="approved-count">5 clips aprobados</div>

                <div id="approved-list" class="approved-list">
                    <!-- Lista generada dinamicamente -->
                </div>

                <div class="preset-selector">
                    <label>Preset de subtitulos:</label>
                    <select id="subtitle-preset">
                        <option value="viral_yellow">Viral Yellow</option>
                        <option value="minimal_white">Minimal White</option>
                        <option value="none">Sin subtitulos</option>
                    </select>
                </div>

                <div class="source-reminder">
                    <span class="reminder-icon">‚ö†Ô∏è</span>
                    <span>Selecciona el video source en el <strong>Panel de Proyecto</strong> antes de generar</span>
                </div>

                <button id="generate-btn" class="primary-btn">
                    Generar Secuencias
                </button>

                <div id="countdown" class="countdown hidden">
                    Auto-inicia en <span id="countdown-num">3</span>s...
                </div>
            </div>
        </section>

        <!-- Estado: Analyzing -->
        <section id="analyzing-state" class="state">
            <header class="panel-header">
                <span>Analizando...</span>
                <button id="cancel-analysis" class="icon-btn" title="Cancelar">√ó</button>
            </header>

            <div class="content">
                <div class="analysis-header">
                    <div class="loader"></div>
                    <p id="analysis-status">Conectando con IA...</p>
                </div>
                <div id="analysis-progress" class="progress-bar">
                    <div id="analysis-progress-fill" class="progress-fill"></div>
                </div>
                <div id="thinking-preview" class="thinking-preview hidden">
                    <span class="thinking-label">Razonando...</span>
                    <p id="thinking-text"></p>
                </div>
                <p id="moments-found" class="moments-found">0 momentos encontrados</p>
                <p id="tokens-count" class="tokens-count"></p>
            </div>
        </section>

        <!-- Estado: Generating -->
        <section id="generating-state" class="state">
            <header class="panel-header">
                <span>Generando Clips...</span>
            </header>

            <div class="content">
                <div id="generation-progress" class="progress-bar">
                    <div id="generation-progress-fill" class="progress-fill"></div>
                </div>
                <p id="generation-status">Creando secuencias...</p>

                <div id="generation-list" class="generation-list">
                    <!-- Lista generada dinamicamente -->
                </div>

                <p class="continue-tip">Puedes seguir trabajando en Premiere.<br>Te notificaremos cuando termine.</p>

                <div id="export-help" class="export-help hidden">
                    <div class="help-header">
                        <span class="folder-icon">üìÅ</span>
                        <span>Secuencias en carpeta "AutoClipper"</span>
                    </div>
                    <div class="help-steps">
                        <p><strong>Subtitulos (.srt):</strong></p>
                        <ol>
                            <li>Los archivos .srt estan en la carpeta "AutoClipper"</li>
                            <li>Arrastra el .srt sobre su secuencia para subtitulos</li>
                        </ol>
                        <p><strong>Para exportar a Media Encoder:</strong></p>
                        <ol>
                            <li>Ve al panel de Proyecto</li>
                            <li>Abre la carpeta "AutoClipper"</li>
                            <li>Selecciona todas (Ctrl+A)</li>
                            <li>Click derecho ‚Üí "Export Media"</li>
                            <li>En Media Encoder: Queue ‚Üí Start</li>
                        </ol>
                    </div>
                    <button id="open-bin-btn" class="secondary-btn">
                        Abrir carpeta AutoClipper
                    </button>
                </div>
            </div>
        </section>

        <!-- Estado: Error -->
        <section id="error-state" class="state">
            <header class="panel-header">
                <span>Error</span>
                <button id="close-error" class="icon-btn" title="Cerrar">√ó</button>
            </header>

            <div class="content">
                <div class="error-header">
                    <div class="error-icon">!</div>
                    <p id="error-message">Error de conexion</p>
                </div>
                <div id="error-details" class="error-details hidden">
                    <span class="details-label">Detalles:</span>
                    <pre id="error-raw"></pre>
                </div>
                <button id="retry-btn" class="primary-btn">Reintentar</button>
                <button id="fallback-btn" class="secondary-btn">Configurar Backend</button>
                <button id="show-details-btn" class="secondary-btn">Ver respuesta del modelo</button>
            </div>
        </section>

        <!-- Estado: Settings -->
        <section id="settings-state" class="state">
            <header class="panel-header">
                <button id="back-from-settings" class="icon-btn" title="Volver">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"/>
                    </svg>
                </button>
                <span>Configuracion</span>
                <span></span>
            </header>

            <div class="content">
                <!-- Account Section -->
                <div id="account-section" class="account-section">
                    <label class="input-label">Cuenta:</label>

                    <div id="auth-form" class="auth-form">
                        <input type="email" id="auth-email" class="text-input" placeholder="Email">
                        <input type="password" id="auth-password" class="text-input" placeholder="Contrasena" style="margin-top: 8px;">
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <button id="auth-login-btn" class="primary-btn" style="flex: 1;">Iniciar sesion</button>
                            <button id="auth-signup-btn" class="secondary-btn" style="flex: 1;">Registrarse</button>
                        </div>
                        <div id="auth-status" class="info-bar hidden" style="margin-top: 8px;">
                            <span id="auth-status-text"></span>
                        </div>
                        <p class="tip" style="margin-top: 8px;">
                            Crea una cuenta para generar secuencias ilimitadas.<br>
                            Sin cuenta = 3 clips gratis por analisis.
                        </p>
                    </div>

                    <div id="account-info" class="account-info hidden">
                        <div class="account-card">
                            <span id="account-email" class="account-email">user@email.com</span>
                            <span id="account-plan-badge" class="plan-badge plan-free">Free</span>
                        </div>
                        <button id="upgrade-btn" class="primary-btn upgrade-btn" style="margin-top: 8px;">
                            Upgrade a Pro
                        </button>
                        <button id="refresh-plan-btn" class="secondary-btn" style="margin-top: 8px;">
                            Actualizar estado del plan
                        </button>
                        <button id="auth-logout-btn" class="secondary-btn" style="margin-top: 8px;">
                            Cerrar sesion
                        </button>
                    </div>
                </div>

                <hr class="settings-divider">

                <label class="input-label">Backend de IA:</label>
                <div class="backend-selector">
                    <button id="backend-openrouter" class="backend-btn active" data-backend="openrouter">
                        <span class="backend-icon">‚òÅÔ∏è</span>
                        <span class="backend-name">OpenRouter</span>
                        <span class="backend-desc">API online, gratis</span>
                    </button>
                    <button id="backend-ollama" class="backend-btn" data-backend="ollama">
                        <span class="backend-icon">üñ•Ô∏è</span>
                        <span class="backend-name">Ollama Local</span>
                        <span class="backend-desc">100% offline</span>
                    </button>
                </div>

                <!-- OpenRouter Config -->
                <div id="openrouter-config" class="backend-config">
                    <label class="input-label">OpenRouter API Key:</label>
                    <input type="password" id="api-key-input" class="text-input" placeholder="sk-or-v1-...">
                    <p class="tip" style="margin-top: 8px;">
                        Gratis en <a href="#" id="get-key-link">openrouter.ai/keys</a>
                    </p>
                </div>

                <!-- Ollama Config -->
                <div id="ollama-config" class="backend-config hidden">
                    <label class="input-label">Servidor Ollama:</label>
                    <input type="text" id="ollama-url-input" class="text-input" placeholder="http://localhost:11434" value="http://localhost:11434">

                    <label class="input-label" style="margin-top: 12px;">Modelo:</label>
                    <select id="ollama-model-select" class="text-input">
                        <option value="">-- Detectar modelos --</option>
                    </select>
                    <button id="refresh-models-btn" class="secondary-btn" style="margin-top: 8px;">
                        Detectar modelos
                    </button>
                    <p class="tip" style="margin-top: 8px;">
                        Recomendado: qwen2.5:14b o llama3.1:8b
                    </p>
                </div>

                <button id="save-key-btn" class="primary-btn" style="margin-top: 16px;">
                    Guardar
                </button>

                <div id="key-status" class="info-bar hidden" style="margin-top: 12px;">
                    <span class="check-icon">&#10003;</span>
                    <span>Configuracion guardada</span>
                </div>
            </div>
        </section>
    </div>

    <script src="js/lib/CSInterface.js"></script>
    <script src="js/modules/srt-parser.js"></script>
    <script src="js/modules/openrouter-client.js"></script>
    <script src="js/modules/ollama-client.js"></script>
    <script src="js/modules/auth-client.js"></script>
    <script src="js/modules/ui-controller.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
